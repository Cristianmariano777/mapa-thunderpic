<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Registros ThunderPIC</title>

<!-- Librer√≠a Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; font-family:sans-serif; }
  h3 { text-align:center; background:#222; color:#fff; margin:0; padding:10px; }
  #map { height: 92vh; width: 100%; }
</style>
</head>
<body>
<h3>üó∫Ô∏è Registros ThunderPIC</h3>
<div id="map"></div>

<script>
async function cargarDatos() {
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAzoGjM-TqXk4t2QqWSCXJ6O6lMDRgGYPrYto4TIkDJAvBCAxkHUGO823whepvQbpuPzYtKend9EN4/pub?gid=0&single=true&output=csv"; // üîó Reemplaza con tu URL
  const response = await fetch(url);
  const texto = await response.text();

  // ‚úÖ Manejo avanzado del CSV
  const filas = texto.trim().split(/\r?\n/);
  const encabezados = filas[0].split(',').map(h => h.trim());
  const registros = filas.slice(1).map(fila => {
    // Divide solo por comas que no est√©n dentro de comillas
    const celdas = [];
    let actual = '';
    let dentroComillas = false;

    for (let i = 0; i < fila.length; i++) {
      const char = fila[i];
      if (char === '"') {
        dentroComillas = !dentroComillas;
      } else if (char === ',' && !dentroComillas) {
        celdas.push(actual.trim().replace(/^"|"$/g, ''));
        actual = '';
      } else {
        actual += char;
      }
    }
    celdas.push(actual.trim().replace(/^"|"$/g, ''));

    const obj = {};
    encabezados.forEach((h, i) => obj[h] = celdas[i]);
    return obj;
  });

  return registros;
}

// ‚úÖ Cargar y mostrar los pines
async function mostrarPines(map) {
  const datos = await cargarDatos();
  datos.forEach(row => {
    const coords = row['Coordenadas']?.split(',');
    if (!coords || coords.length < 2) return;

    const lat = parseFloat(coords[0]);
    const lng = parseFloat(coords[1]);

    const marker = new google.maps.Marker({
      position: { lat, lng },
      map: map,
      title: row['Nombre'] || 'Sin nombre'
    });

    const contenido = `
      <b>${row['Nombre'] || ''}</b><br>
      ${row['Direccion'] || ''}<br>
      ${row['Distrito'] || ''}, ${row['Provincia'] || ''}<br>
      <b>Servicio:</b> ${row['Servicio'] || ''}<br>
      <b>Fecha:</b> ${row['Fecha'] || ''}
    `;
    const infowindow = new google.maps.InfoWindow({ content: contenido });

    marker.addListener('click', () => infowindow.open(map, marker));
  });
}

// Inicializa el mapa
function initMap() {
  const map = new google.maps.Map(document.getElementById('map'), {
    zoom: 7,
    center: { lat: -9.19, lng: -75.0152 },
  });
  mostrarPines(map);
}
</script>
