<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Registros ThunderPIC</title>

<!-- Librer√≠a Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { margin:0; font-family:sans-serif; }
  h3 { text-align:center; background:#222; color:#fff; margin:0; padding:10px; }
  #map { height: 92vh; width: 100%; }
</style>
</head>
<body>
<h3>üó∫Ô∏è Registros ThunderPIC</h3>
<div id="map"></div>

<script>
const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAzoGjM-TqXk4t2QqWSCXJ6O6lMDRgGYPrYto4TIkDJAvBCAxkHUGO823whepvQbpuPzYtKend9EN4/pub?gid=0&single=true&output=csv"; // üîó Reemplaza con tu URL

async function cargarDatos() {
  const resp = await fetch(url);
  const texto = await resp.text();

  // Detectar si el CSV tiene comillas y comas dentro
  const filas = texto.trim().split("\n").slice(1);

  const mapa = L.map('map').setView([-9.19, -75.02], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(mapa);

  filas.forEach(fila => {
    // divide pero respeta las comillas
    const columnas = fila.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);

    const nombre = columnas[1];
    const direccion = columnas[2];
    const distrito = columnas[3];
    const servicio = columnas[6];
    const coordenadas = columnas[7];
    const foto1 = columnas[8];
    const usuario = columnas[10];
    const fecha = columnas[11];

    if (coordenadas && coordenadas.includes(",")) {
      const [lat, lng] = coordenadas.replace(/"/g, '').split(",").map(x => parseFloat(x.trim()));
      if (!isNaN(lat) && !isNaN(lng)) {
        L.marker([lat, lng]).addTo(mapa)
          .bindPopup(`
            <b>${nombre}</b><br>
            ${direccion}<br>
            ${distrito}<br>
            Servicio: ${servicio}<br>
            Usuario: ${usuario}<br>
            Fecha: ${fecha}<br>
            ${foto1 ? `<img src="${foto1}" width="120">` : ""}
          `);
      }
    }
  });
}
cargarDatos();
</script>